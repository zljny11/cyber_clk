<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>30:00 | SYSTEM READY</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <style>
        /* === CYBERPUNK 2077 VISUAL IDENTITY === */
        :root {
            --cp-yellow: #fcee0a;
            --cp-blue: #00f0ff;
            --cp-red: #ff003c;
            --cp-green: #00ff9f;
            --font-main: 'Courier New', Courier, monospace;
        }

        body {
            margin: 0;
            overflow: hidden;
            background-color: #000;
            font-family: 'Segoe UI', 'Roboto', Helvetica, Arial, sans-serif;
            color: var(--cp-yellow);
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        /* === è§†è§‰å±‚ === */
        #bg-layer {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -2;
            background-size: cover;
            background-position: center;
            background-image: url('101454734.jpg');
            filter: contrast(1.1) brightness(0.6);
            transition: background-image 0.5s ease;
        }

        #scanlines {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            background: linear-gradient(to bottom, rgba(255, 255, 255, 0), rgba(255, 255, 255, 0) 50%, rgba(0, 0, 0, 0.3) 50%, rgba(0, 0, 0, 0.3));
            background-size: 100% 4px;
            pointer-events: none;
        }

        #canvas-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 0;
            pointer-events: none;
            mix-blend-mode: screen;
        }

        /* === ä¸»é¢æ¿ UI === */
        .cyber-panel {
            position: relative;
            z-index: 10;
            width: 400px;
            padding: 40px;
            background: rgba(5, 5, 5, 0.6);
            clip-path: polygon(0 0, 100% 0, 100% 90%, 90% 100%, 0 100%);
            border-left: 4px solid var(--cp-yellow);
            box-shadow: 0 0 40px rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            display: flex;
            flex-direction: column;
        }

        .top-nav {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-bottom: 20px;
        }

        .nav-btn {
            background: transparent;
            border: 1px solid var(--cp-yellow);
            color: var(--cp-yellow);
            padding: 5px 10px;
            cursor: pointer;
            font-family: var(--font-main);
            font-weight: bold;
            font-size: 12px;
            transition: 0.2s;
            letter-spacing: 1px;
            user-select: none;
        }

        .nav-btn:hover,
        .nav-btn.active-btn {
            background: var(--cp-yellow);
            color: black;
            box-shadow: 0 0 10px var(--cp-yellow);
        }

        .timer-wrapper {
            text-align: center;
            margin: 10px 0 20px 0;
        }

        .timer-display {
            font-size: 80px;
            font-weight: 900;
            color: var(--cp-blue);
            text-shadow: 0 0 20px rgba(0, 240, 255, 0.5);
            font-family: 'Arial Black', sans-serif;
            letter-spacing: -2px;
            line-height: 1;
        }

        .status-badge {
            display: inline-block;
            background: rgba(0, 0, 0, 0.6);
            border: 1px solid var(--cp-blue);
            color: var(--cp-blue);
            padding: 4px 12px;
            font-size: 12px;
            letter-spacing: 2px;
            font-weight: bold;
            text-transform: uppercase;
            margin-top: 5px;
        }

        .progress-container {
            width: 100%;
            height: 6px;
            background: #222;
            margin-bottom: 25px;
            position: relative;
            overflow: hidden;
        }

        .progress-bar {
            width: 0%;
            height: 100%;
            background: var(--cp-yellow);
            box-shadow: 0 0 10px var(--cp-yellow);
            transition: width 1s linear;
        }

        .cyber-input {
            background: rgba(255, 255, 255, 0.05);
            border: none;
            border-bottom: 2px solid #555;
            color: white;
            width: 100%;
            padding: 15px;
            font-size: 16px;
            font-family: var(--font-main);
            outline: none;
            margin-bottom: 25px;
            box-sizing: border-box;
            transition: 0.3s;
        }

        .cyber-input:focus {
            background: rgba(0, 240, 255, 0.1);
            border-color: var(--cp-blue);
        }

        .glitch-btn {
            width: 100%;
            padding: 20px;
            background: var(--cp-yellow);
            color: black;
            border: none;
            font-size: 24px;
            font-weight: 900;
            text-transform: uppercase;
            cursor: pointer;
            clip-path: polygon(15px 0, 100% 0, 100% calc(100% - 15px), calc(100% - 15px) 100%, 0 100%, 0 15px);
            transition: 0.2s;
            letter-spacing: 2px;
            font-family: 'Arial Black', sans-serif;
        }

        .glitch-btn:hover {
            background: #fff;
            transform: translate(-2px, -2px);
            box-shadow: 5px 5px 0 var(--cp-blue);
        }

        .glitch-btn:disabled {
            background: #555;
            color: #888;
            cursor: not-allowed;
            box-shadow: none;
            transform: none;
        }

        .pause-btn {
            background: transparent;
            border: 1px dashed #666;
            color: #888;
            width: 100%;
            padding: 12px;
            margin-top: 15px;
            cursor: pointer;
            text-transform: uppercase;
            font-size: 12px;
            transition: 0.3s;
        }

        .pause-btn:hover {
            border-color: var(--cp-yellow);
            color: var(--cp-yellow);
        }

        /* === ä¾§è¾¹æ‚¬æµ®é¢æ¿ === */
        .slide-panel {
            position: absolute;
            top: 20px;
            right: 20px;
            bottom: 20px;
            width: 340px;
            background: rgba(10, 10, 12, 0.95);
            z-index: 50;
            padding: 25px;
            box-sizing: border-box;
            transform: translateX(120%);
            transition: transform 0.3s cubic-bezier(0.19, 1, 0.22, 1);
            border: 1px solid #333;
            border-right: 4px solid var(--cp-blue);
            box-shadow: -10px 0 40px rgba(0, 0, 0, 0.8);
            display: flex;
            flex-direction: column;
        }

        .slide-panel.active {
            transform: translateX(0);
        }

        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #333;
            padding-bottom: 15px;
            margin-bottom: 15px;
        }

        .panel-title {
            font-size: 18px;
            font-weight: bold;
            color: var(--cp-blue);
            letter-spacing: 1px;
        }

        .stats-section {
            flex: 1;
            overflow-y: auto;
            padding-right: 5px;
        }

        .stats-section::-webkit-scrollbar {
            width: 4px;
        }

        .stats-section::-webkit-scrollbar-thumb {
            background: #333;
        }

        .stats-card {
            background: rgba(255, 255, 255, 0.03);
            padding: 15px;
            margin-bottom: 15px;
            border: 1px solid #222;
        }

        canvas#trendChart {
            width: 100%;
            height: 100px;
            display: block;
        }

        .achievement-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 5px;
            margin-top: 10px;
        }

        .ach-badge {
            aspect-ratio: 1;
            border: 1px solid #333;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            color: #333;
            cursor: pointer;
            position: relative;
            transition: 0.3s;
            background: #000;
        }

        .ach-badge.unlocked {
            border-color: var(--cp-green);
            color: var(--cp-green);
            box-shadow: 0 0 5px var(--cp-green);
            text-shadow: 0 0 5px var(--cp-green);
        }

        #ach-desc {
            margin-top: 10px;
            min-height: 20px;
            font-size: 12px;
            color: var(--cp-blue);
            text-align: center;
            border-top: 1px dashed #333;
            padding-top: 8px;
            font-family: var(--font-main);
        }

        .purge-btn {
            background: rgba(255, 0, 60, 0.2);
            border: 1px solid var(--cp-red);
            color: var(--cp-red);
            font-size: 10px;
            padding: 4px 8px;
            cursor: pointer;
            font-family: var(--font-main);
            transition: 0.2s;
        }

        .purge-btn:hover {
            background: var(--cp-red);
            color: black;
        }

        /* === å¼¹çª—é€šç”¨ === */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.85);
            z-index: 100;
            display: none;
            justify-content: center;
            align-items: center;
        }

        .modal-box {
            width: 400px;
            background: #080808;
            border: 1px solid var(--cp-red);
            padding: 30px;
            text-align: center;
            box-shadow: 0 0 50px rgba(255, 0, 60, 0.2);
            position: relative;
        }

        .modal-box.rating-mode {
            border-color: var(--cp-yellow);
            box-shadow: 0 0 30px rgba(252, 238, 10, 0.2);
        }

        .modal-box::before {
            content: '';
            position: absolute;
            top: -1px;
            left: -1px;
            width: 15px;
            height: 15px;
            border-top: 2px solid currentColor;
            border-left: 2px solid currentColor;
        }

        .modal-box::after {
            content: '';
            position: absolute;
            bottom: -1px;
            right: -1px;
            width: 15px;
            height: 15px;
            border-bottom: 2px solid currentColor;
            border-right: 2px solid currentColor;
        }

        textarea.pause-reason {
            width: 100%;
            height: 80px;
            background: #111;
            border: 1px solid #333;
            color: white;
            padding: 10px;
            margin: 15px 0;
            font-family: var(--font-main);
            resize: none;
            box-sizing: border-box;
        }

        .stars-container {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin: 25px 0;
        }

        .star-btn {
            font-size: 32px;
            cursor: pointer;
            color: #333;
            transition: 0.2s;
            user-select: none;
        }

        .star-btn.active {
            color: var(--cp-yellow);
            text-shadow: 0 0 15px var(--cp-yellow);
            transform: scale(1.1);
        }

        #file-inputs {
            display: none;
        }

        /* === ç”µå°æ ·å¼ === */
        .station-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 25px;
        }

        .station-btn {
            background: rgba(0, 0, 0, 0.5);
            border: 1px solid #333;
            color: #666;
            padding: 15px 10px;
            cursor: pointer;
            font-family: var(--font-main);
            text-transform: uppercase;
            transition: 0.3s;
            font-size: 12px;
            letter-spacing: 1px;
        }

        .station-btn:hover {
            border-color: var(--cp-blue);
            color: var(--cp-blue);
            box-shadow: 0 0 10px rgba(0, 240, 255, 0.2);
        }

        .station-btn.active-station {
            background: var(--cp-yellow);
            color: black;
            border-color: var(--cp-yellow);
            box-shadow: 0 0 15px var(--cp-yellow);
            font-weight: bold;
        }

        /* èµ›åšæœ‹å…‹é£æ ¼çš„æ»‘åŠ¨æ¡ */
        .volume-control label {
            display: block;
            color: var(--cp-blue);
            font-size: 10px;
            margin-bottom: 8px;
            letter-spacing: 2px;
        }

        .cyber-range {
            -webkit-appearance: none;
            width: 100%;
            height: 4px;
            background: #333;
            outline: none;
            opacity: 0.7;
            transition: opacity .2s;
        }

        .cyber-range::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 15px;
            height: 15px;
            background: var(--cp-red);
            cursor: pointer;
            border: 2px solid black;
        }

        .cyber-range:hover {
            opacity: 1;
        }

        /* === å£çº¸é¢æ¿æ ·å¼ === */
        .bg-selector-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
            /* å¦‚æœå›¾ç‰‡å¤ªå¤šï¼Œå…è®¸æ»šåŠ¨ */
        }

        .bg-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            /* ä¸¤åˆ—æ˜¾ç¤º */
            gap: 15px;
            padding-bottom: 20px;
            border-bottom: 1px dashed #333;
            margin-bottom: 20px;
        }

        .bg-thumb {
            aspect-ratio: 16 / 9;
            /* å¼ºåˆ¶å®½å±æ¯”ä¾‹ä½œä¸ºç¼©ç•¥å›¾ */
            background-size: cover;
            background-position: center;
            border: 2px solid #333;
            cursor: pointer;
            transition: 0.3s all ease;
            opacity: 0.6;
            filter: grayscale(0.5);
            /* é»˜è®¤ç¨å¾®ç°ä¸€ç‚¹ */
        }

        .bg-thumb:hover {
            opacity: 1;
            filter: grayscale(0);
            border-color: var(--cp-blue);
            box-shadow: 0 0 10px rgba(0, 240, 255, 0.3);
        }

        /* é€‰ä¸­çŠ¶æ€ */
        .bg-thumb.active-bg {
            opacity: 1;
            filter: grayscale(0);
            border-color: var(--cp-yellow);
            box-shadow: 0 0 15px var(--cp-yellow);
            transform: scale(1.02);
            /* é€‰ä¸­æ—¶ç¨å¾®æ”¾å¤§ä¸€ç‚¹ç‚¹ */
        }

        .custom-upload-section {
            margin-top: auto;
            /* æŠŠå®ƒæŒ¤åˆ°æœ€ä¸‹é¢ */
            padding-top: 20px;
        }

        /* === è§’è½å…¨å±æŒ‰é’® === */
        .fullscreen-corner-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 40px;
            height: 40px;
            background: rgba(0, 0, 0, 0.5);
            border: 1px solid #333;
            color: #666;
            font-size: 20px;
            cursor: pointer;
            z-index: 100;
            /* ä¿è¯åœ¨æœ€ä¸Šå±‚ */
            transition: all 0.3s ease;
            display: flex;
            justify-content: center;
            align-items: center;
            /* åˆ‡è§’è®¾è®¡ï¼Œæ›´æœ‰ç§‘æŠ€æ„Ÿ */
            clip-path: polygon(10px 0, 100% 0, 100% calc(100% - 10px), calc(100% - 10px) 100%, 0 100%, 0 10px);
        }

        .fullscreen-corner-btn:hover {
            border-color: var(--cp-blue);
            color: var(--cp-blue);
            background: rgba(0, 0, 0, 0.8);
            box-shadow: 0 0 15px rgba(0, 240, 255, 0.3);
            transform: scale(1.1);
        }
    </style>
</head>

<body>

    <div id="bg-layer"></div>
    <div id="scanlines"></div>
    <div id="canvas-container"></div>

    <div class="cyber-panel" id="main-panel">
        <div class="top-nav">
            <button class="nav-btn" onclick="document.getElementById('music-input').click()">ğŸµ BGM</button>
            <button class="nav-btn" id="btn-bg" onclick="togglePanel('bg')">ğŸ–¼ï¸ BG</button>
            <button class="nav-btn" id="btn-sys" onclick="togglePanel('settings')">âš™ï¸ SYS</button>
            <button class="nav-btn" id="btn-stats" onclick="togglePanel('stats');">ğŸ“Š DAT</button>
            <button class="nav-btn" id="btn-radio" onclick="togglePanel('radio')">ğŸ“¡ RADIO</button>
        </div>


        <div style="display:none;" id="file-inputs">
            <input type="file" id="bg-input-gallery" accept="image/*" onchange="handleFileUpload(this, 'image', false)">
            <input type="file" id="bg-input-apply" accept="image/*" onchange="handleFileUpload(this, 'image', true)">
            <input type="file" id="music-input" accept="audio/*" onchange="loadMusic(this)">
        </div>

        <div style="flex:1; display:flex; flex-direction:column; justify-content:center;">
            <div class="timer-wrapper">
                <div class="timer-display" id="timer">30:00</div>
                <div class="status-badge" id="status-badge">READY TO BREACH</div>
            </div>

            <div class="progress-container">
                <div class="progress-bar" id="progress-bar"></div>
            </div>

            <input type="text" class="cyber-input" id="task-input" placeholder=">> è®¾å®šå…¥ä¾µç›®æ ‡..." autocomplete="off">

            <button class="glitch-btn" id="action-btn" onclick="handleMainAction()">å¼€å§‹å…¥ä¾µ...</button>
            <button class="pause-btn" id="pause-btn" onclick="requestPause()" style="display:none;">// ç”³è¯·æŒ‚èµ·</button>
        </div>
    </div>

    <div class="slide-panel" id="stats-panel">
        <div class="panel-header">
            <span class="panel-title">MISSION ARCHIVE</span>
            <button class="purge-btn" onclick="purgeData()">âš ï¸ PURGE DATABASE</button>
        </div>

        <div class="stats-section">
            <div class="stats-card">
                <div style="font-size: 11px; color: #888; margin-bottom: 5px;">ACHIEVEMENTS (æˆå°±åè®®)</div>
                <div class="achievement-grid" id="ach-container"></div>
                <div id="ach-desc">HOVER ICON FOR DETAILS</div>
            </div>

            <div class="stats-card">
                <div style="font-size: 11px; color: #888; margin-bottom: 5px;">ä¸“æ³¨è´¨é‡è¶‹åŠ¿ (æœ€è¿‘10æ¬¡)</div>
                <canvas id="trendChart"></canvas>
            </div>

            <div class="stats-card">
                <div style="font-size: 11px; color: #888; margin-bottom: 5px;">ä»Šæ—¥å·²å…¥ä¾µæ—¶é•¿</div>
                <div style="font-size: 24px; font-weight:bold; color:white;" id="today-total">0m</div>
            </div>

            <div style="font-size:12px; color:var(--cp-yellow); margin:10px 0;">è¯¦ç»†æ—¥å¿—:</div>
            <div id="task-list" style="font-size:12px; color:#ccc;"></div>
        </div>
    </div>

    <div class="slide-panel" id="settings-panel">
        <div class="panel-header">
            <span class="panel-title">SYSTEM CONFIG</span>
        </div>

        <div style="margin-top:20px; border-bottom: 1px dashed #333; padding-bottom: 20px;">
            <label style="color:var(--cp-blue); font-size:12px; display:block; margin-bottom:10px;">å…¥ä¾µæ—¶é•¿ (MIN)</label>
            <input type="number" class="cyber-input" id="cfg-work" value="30">
            <label style="color:var(--cp-blue); font-size:12px; display:block; margin-bottom:10px;">å†·å´æ—¶é•¿ (MIN)</label>
            <input type="number" class="cyber-input" id="cfg-break" value="5">
            <button class="glitch-btn" onclick="saveSettings()" style="font-size:16px; margin-top:20px;">ä¿å­˜é…ç½®</button>
            <button class="purge-btn" onclick="CyberDB.deleteDB()" style="margin-top:10px; width:100%;">âš ï¸ é‡ç½®æ•°æ®åº“
                (ä¿®å¤å¡æ­»)</button>
        </div>

        <div class="system-section" style="margin-top: 20px;">
            <h3 style="font-size:14px; color:var(--cp-yellow); margin-bottom:10px;">// MISSION TEMPLATES</h3>

            <div id="mission-template-list"
                style="max-height: 200px; overflow-y: auto; padding-right: 5px; margin-bottom:15px;">
                <div style="color:#666; font-size:10px;">LOADING...</div>
            </div>

            <div style="padding-top: 10px; border-top: 1px dashed #333;">
                <input type="text" id="new-mission-name" placeholder="ä»»åŠ¡å (BREACH TARGET)" class="cyber-input"
                    style="width: 100%; margin-bottom: 5px; box-sizing: border-box;">
                <div style="display: flex; gap: 5px;">
                    <input type="number" id="new-mission-minutes" placeholder="åˆ†é’Ÿ" class="cyber-input"
                        style="width: 50%;">
                    <input type="number" id="new-mission-seconds" placeholder="ç§’" class="cyber-input"
                        style="width: 50%;">
                </div>
                <button class="glitch-btn" onclick="addMissionTemplate()"
                    style="width: 100%; margin-top: 5px; font-size: 12px; border: 1px dashed var(--cp-blue); color: var(--cp-blue); background: transparent;">
                    + ADD TEMPLATE
                </button>
            </div>
        </div>

    </div>
    <div class="modal-overlay" id="pause-modal">
        <div class="modal-box">
            <h2 style="color:var(--cp-red); margin-top:0;">âš ï¸ æš‚åœè­¦å‘Š</h2>
            <p style="color:#aaa; font-size:13px; text-align:left;">æ ¹æ®åè®®ï¼Œæš‚åœéœ€è¦æ­£å½“ç†ç”±ï¼ˆè‡³å°‘10å­—ï¼‰ã€‚<br>æš‚åœè¶…è¿‡ <span
                    style="color:white;">10åˆ†é’Ÿ</span> å°†å¯¼è‡´ç¥ç»è¿æ¥ä¸­æ–­ï¼ˆä»»åŠ¡å¤±è´¥ï¼‰ã€‚</p>
            <textarea class="pause-reason" id="pause-reason-input" placeholder="è¾“å…¥ç†ç”±..."></textarea>
            <div style="display:flex; gap:10px;">
                <button class="glitch-btn" onclick="cancelPauseRequest()"
                    style="background:#333; font-size:14px; color:white;">å–æ¶ˆ</button>
                <button class="glitch-btn" id="confirm-pause-btn" onclick="confirmPause()"
                    style="background:var(--cp-red); font-size:14px;">ç¡®è®¤æŒ‚èµ·</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="rating-modal">
        <div class="modal-box rating-mode">
            <h2 style="color:var(--cp-yellow); margin-top:0;">å…¥ä¾µå®Œæˆ</h2>
            <p style="color:#aaa; font-size:14px;">ç¥ç»åŒæ­¥ç‡è¯„ä¼°</p>
            <div class="stars-container">
                <span class="star-btn" onclick="setRating(1)" data-v="1">â˜…</span>
                <span class="star-btn" onclick="setRating(2)" data-v="2">â˜…</span>
                <span class="star-btn" onclick="setRating(3)" data-v="3">â˜…</span>
                <span class="star-btn" onclick="setRating(4)" data-v="4">â˜…</span>
                <span class="star-btn" onclick="setRating(5)" data-v="5">â˜…</span>
            </div>
            <button class="glitch-btn" id="submit-rating-btn" onclick="submitRating()"
                style="font-size:16px;">ä¸Šä¼ æ•°æ®</button>
        </div>
    </div>

    <div class="slide-panel" id="radio-panel">
        <div class="panel-header">
            <span class="panel-title">NEURAL FREQUENCY</span>
            <div style="font-size:10px; color:var(--cp-green)" id="radio-status">OFFLINE</div>
        </div>

        <div class="radio-interface">
            <div class="station-grid">
                <button class="station-btn" onclick="switchStation(0)">ğŸŒ§ï¸ Rain</button>
                <button class="station-btn" onclick="switchStation(1)">ğŸ¹ Jazz</button>
                <button class="station-btn" onclick="switchStation(2)">ğŸŒƒ Synth</button>
                <button class="station-btn" onclick="switchStation(3)">ğŸ§ HipHop</button>
                <button class="station-btn" onclick="switchStation(4)">ğŸŒŠ White</button>
            </div>

            <div class="volume-control">
                <label>GAIN LEVEL</label>
                <input type="range" class="cyber-range" min="0" max="100" value="50"
                    oninput="setRadioVolume(this.value)">
            </div>

            <div style="margin-top: 25px; border-top: 1px dashed #333; padding-top: 15px;">
                <label style="color:var(--cp-yellow); font-size:12px;">LOCAL STORAGE (æœ¬åœ°å­˜å‚¨)</label>
                <div id="local-audio-list" style="margin-top:10px; max-height: 150px; overflow-y: auto;">
                    <div style="color:#666; font-size:10px;">æš‚æ— ä¸Šä¼ éŸ³ä¹...</div>
                </div>
                <button class="glitch-btn" onclick="document.getElementById('music-input').click()"
                    style="font-size:12px; padding:10px; margin-top:10px; background:var(--cp-yellow); color:black; font-weight:bold; border:none; box-shadow: 0 0 10px var(--cp-yellow);">
                    + UPLOAD NEW TRACK
                </button>
            </div>

            <button class="glitch-btn" id="cut-signal-btn" onclick="stopRadio()"
                style="margin-top:20px; font-size:14px; background:#333; color:#888;">// CUT SIGNAL</button>
        </div>
    </div>

    <div class="slide-panel" id="bg-panel">
        <div class="panel-header">
            <span class="panel-title">VISUAL DATABASE</span>
        </div>

        <div class="bg-selector-container">
            <div class="bg-grid">
                <div style="font-size: 12px; color: var(--cp-yellow); margin: 20px 0 10px 0;">LOCAL GALLERY</div>
                <div class="bg-grid" id="local-bg-list">
                </div>

                <div class="custom-upload-section">
                    <button class="glitch-btn" onclick="document.getElementById('bg-input-gallery').click()"
                        style="font-size:14px; padding: 15px; border: 1px dashed var(--cp-yellow); background: transparent; color: var(--cp-yellow);">
                        // UPLOAD TO GALLERY
                    </button>
                </div>

                <button class="bg-thumb active-bg" style="background-image: url('101454734.jpg')"
                    data-src="101454734.jpg" onclick="switchBackground(this)">
                </button>

                <button class="bg-thumb" style="background-image: url('bg/cp1.jpg')" data-src="bg/cp1.jpg"
                    onclick="switchBackground(this)">
                </button>

                <button class="bg-thumb" style="background-image: url('bg/cp2.jpg')" data-src="bg/cp2.jpg"
                    onclick="switchBackground(this)">
                </button>

                <button class="bg-thumb" style="background-image: url('bg/cp3.png')" data-src="bg/cp3.png"
                    onclick="switchBackground(this)">
                </button>

                <button class="bg-thumb" style="background-image: url('bg/cp4.jpg')" data-src="bg/cp4.jpg"
                    onclick="switchBackground(this)">
                </button>
            </div>

            <div class="custom-upload-section">
                <div style="font-size: 12px; color: #666; margin-bottom: 10px;">Wait a minute, I'll use my own</div>
                <button class="glitch-btn" onclick="document.getElementById('bg-input-apply').click()"
                    style="font-size:14px; padding: 15px;">
                    // UPLOAD LOCAL FILE
                </button>
            </div>
        </div>
    </div>


    <audio id="bgm-player" loop></audio>

    <script>
        // === CYBER DATABASE (IndexedDB DAO Layer) ===
        const CyberDB = {
            dbName: 'CyberPunkSystem',
            storeName: 'media_warehouse',
            version: 1,

            open: function () {
                return new Promise((resolve, reject) => {
                    const request = indexedDB.open(this.dbName, this.version);

                    request.onupgradeneeded = (e) => {
                        const db = e.target.result;
                        // åˆ›å»ºä»“åº“ï¼Œå¦‚æœä¸å­˜åœ¨
                        if (!db.objectStoreNames.contains(this.storeName)) {
                            db.createObjectStore(this.storeName, { keyPath: 'id', autoIncrement: true });
                        }
                    };

                    request.onsuccess = (e) => resolve(e.target.result);
                    request.onerror = (e) => reject(e);
                });
            },

            // ä¿å­˜åª’ä½“
            addMedia: async function (type, file) {
                const db = await this.open();
                return new Promise((resolve, reject) => {
                    const tx = db.transaction(this.storeName, 'readwrite');
                    const store = tx.objectStore(this.storeName);

                    tx.oncomplete = () => db.close(); // äº‹åŠ¡ç»“æŸç«‹å³å…³é—­è¿æ¥ï¼Œé˜²æ­¢æ­»é”

                    const entity = {
                        type: type,
                        name: file.name,
                        created: new Date(),
                        blob: file
                    };

                    const req = store.add(entity);
                    req.onsuccess = () => resolve('Saved');
                    req.onerror = (e) => reject(e);
                });
            },

            // è·å–æ–‡ä»¶
            getAllByType: async function (targetType) {
                const db = await this.open();
                return new Promise((resolve) => {
                    const tx = db.transaction(this.storeName, 'readonly');
                    const store = tx.objectStore(this.storeName);

                    tx.oncomplete = () => db.close();

                    const request = store.getAll();
                    request.onsuccess = () => {
                        const allItems = request.result;
                        // ç®€å•çš„å†…å­˜è¿‡æ»¤ï¼Œå› ä¸ºæ•°æ®é‡ä¸å¤§
                        const filtered = allItems.filter(item => item.type === targetType);
                        resolve(filtered);
                    };
                });
            },

            // åˆ é™¤å•ä¸ªæ–‡ä»¶
            deleteMedia: async function (id) {
                const db = await this.open();
                return new Promise((resolve, reject) => {
                    const tx = db.transaction(this.storeName, 'readwrite');
                    const store = tx.objectStore(this.storeName);

                    tx.oncomplete = () => db.close();

                    store.delete(id).onsuccess = () => resolve();
                });
            },

            // === ä¿®å¤åçš„é‡åˆ¶æ•°æ®åº“åŠŸèƒ½ ===
            deleteDB: function () {
                if (confirm("âš ï¸ è­¦å‘Šï¼šè¿™å°†æ¸…ç©ºæ‰€æœ‰æœ¬åœ°ä¸Šä¼ çš„å£çº¸å’ŒéŸ³ä¹ã€‚\n\nå¦‚æœç‚¹å‡»ç¡®å®šåæ²¡æœ‰ååº”ï¼Œè¯·æ£€æŸ¥æ˜¯å¦åœ¨å…¶ä»–æ ‡ç­¾é¡µä¹Ÿæ‰“å¼€äº†æ­¤ç½‘ç«™ã€‚\nç¡®å®šè¦æ‰§è¡Œå—ï¼Ÿ")) {

                    const req = indexedDB.deleteDatabase(this.dbName);

                    req.onsuccess = () => {
                        alert(">> SYSTEM PURGED: æ•°æ®åº“å·²å½»åº•é‡ç½®ï¼Œé¡µé¢å³å°†åˆ·æ–°ã€‚");
                        location.reload();
                    };

                    req.onerror = (e) => {
                        console.error("Delete Error:", e);
                        alert(">> ERROR: é‡ç½®å¤±è´¥ï¼Œè¯·å°è¯•å…³é—­æµè§ˆå™¨é‡æ–°æ‰“å¼€ã€‚");
                    };

                    // å¤„ç†æ•°æ®åº“è¢«å ç”¨çš„æƒ…å†µï¼ˆæœ€å¸¸è§çš„é—®é¢˜ï¼‰
                    req.onblocked = () => {
                        alert(">> BUSY SIGNAL: æ•°æ®åº“æ­£è¢«å ç”¨ã€‚\nè¯·å…³é—­å½“å‰æµè§ˆå™¨ä¸­æ‰€æœ‰æ‰“å¼€äº†è¿™ä¸ªç½‘é¡µçš„æ ‡ç­¾é¡µï¼Œç„¶ååªä¿ç•™ä¸€ä¸ªé¡µé¢åˆ·æ–°é‡è¯•ã€‚");
                    };
                }
            }
        };
        // ==========================================
        // 0. WORKER & DATA DEFINITION
        // ==========================================
        const workerScript = `
        self.onmessage = function(e) {
            if (e.data === 'start') {
                if (self.timer) clearInterval(self.timer);
                self.timer = setInterval(() => {
                    self.postMessage('tick');
                }, 1000);
            } else if (e.data === 'stop') {
                if (self.timer) clearInterval(self.timer);
            }
        };
    `;
        const workerBlob = new Blob([workerScript], { type: 'application/javascript' });
        const timerWorker = new Worker(URL.createObjectURL(workerBlob));

        const ACH_DEFS = {
            'rookie': { icon: 'ğŸ£', title: 'åˆå‡ºèŒ…å•: ç´¯è®¡ä¸“æ³¨1å°æ—¶' },
            'thinker': { icon: 'ğŸ§ ', title: 'èµ›åšæ€æƒ³å®¶: ç´¯è®¡ä¸“æ³¨15å°æ—¶' },
            'resilient': { icon: 'ğŸ›¡ï¸', title: 'ç™¾è›°ä¸æŒ : ä¸­æ–­åä»å®Œæˆä»»åŠ¡' },
            'durable': { icon: 'ğŸ”‹', title: 'æŒä¹…è¿˜å¾—çœ‹ä½ : è¿ç»­7å¤©ä½¿ç”¨' },
            'highroller': { icon: 'ğŸ’', title: 'é«˜ï¼ˆåˆ†ï¼‰ç©ï¼ˆå®¶ï¼‰: æœ€è¿‘10æ¬¡å‡åˆ†>4' }
        };

        let appState = {
            active: false,
            paused: false,
            mode: 'work',
            timeLeft: 30 * 60,
            endTime: 0,
            pauseEndTime: 0,
            totalTime: 30 * 60,
            currentTask: '',
            hasPausedInSession: false,
            tempRating: 3
        };

        let config = { work: 30, break: 5 };

        // ==========================================
        // 1. INITIALIZATION & EVENTS
        // ==========================================
        window.onload = async () => {
            initThree();
            // 1. åŠ è½½æ‰€æœ‰æœ¬åœ°æ•°æ®
            renderLocalAudio();
            renderLocalBg();

            // === åœ¨è¿™é‡Œè°ƒç”¨ ===
            loadMissionTemplates();
            // ================

            // 2. åŠ è½½ç”¨æˆ·è®¾ç½®
            const savedCfg = localStorage.getItem('cp_config');
            if (savedCfg) config = JSON.parse(savedCfg);
            document.getElementById('cfg-work').value = config.work;
            document.getElementById('cfg-break').value = config.break;

            // 3. æ¸²æŸ“æˆå°±
            renderAchievements();

            // 4. æ¸²æŸ“æœ¬åœ°æ•°æ®
            renderLocalAudio();
            renderLocalBg();

            // ç§»é™¤æ—§ç‰ˆåŠ è½½é€»è¾‘ï¼Œé¿å…æŠ¥é”™
            // try { ... } catch (e) { ... }
            document.addEventListener('click', (e) => {
                const isClickInsidePanel = e.target.closest('.slide-panel');
                const isClickButton = e.target.closest('.nav-btn');
                const isPurgeButton = e.target.closest('.purge-btn');
                if (!isClickInsidePanel && !isClickButton && !isPurgeButton) {
                    closeAllPanels();
                }
            });



            // åˆå§‹åŒ–æ—¶ç«‹å³æ›´æ–°ä¸€ä¸‹æ ‡é¢˜
            updateTimerDisplay();

            timerWorker.onmessage = (e) => {
                if (e.data === 'tick') {
                    if (appState.active && !appState.paused) {
                        tick();
                    } else if (appState.paused) {
                        pauseTick();
                    }
                }
            };
        };

        // ç¡®ä¿ loadMissionTemplates åœ¨é¡µé¢åŠ è½½æ—¶è¢«è°ƒç”¨
        document.addEventListener('DOMContentLoaded', loadMissionTemplates);
        // é¡µé¢åˆå§‹åŒ–æ—¶ä¹Ÿéœ€è¦é‡æ–°åŠ è½½
        resetUI();


        // ==========================================
        // 2. CORE TIMER LOGIC (WORKER DRIVEN)
        // ==========================================
        function handleMainAction() {
            // æƒ…å†µ 1: è®¡æ—¶å™¨æ­£åœ¨è¿è¡Œ
            if (appState.active) {
                if (appState.mode === 'break') {
                    // === æ–°å¢ï¼šä¼‘æ¯æ¨¡å¼ä¸‹ï¼Œç‚¹å‡»ç›´æ¥è·³è¿‡ ===
                    if (confirm('>> SKIP PROTOCOL: ç¡®è®¤ç»“æŸä¼‘æ¯å¹¶å‡†å¤‡ä¸‹ä¸€æ¬¡å…¥ä¾µï¼Ÿ')) {
                        timerWorker.postMessage('stop');
                        appState.mode = 'work'; // åˆ‡æ¢å›å·¥ä½œæ¨¡å¼
                        resetUI(); // é‡ç½®ç•Œé¢
                    }
                } else {
                    // === åŸæœ‰é€»è¾‘ï¼šå·¥ä½œæ¨¡å¼ä¸‹ï¼Œç‚¹å‡»æ˜¯æ”¾å¼ƒä»»åŠ¡ ===
                    if (confirm('è­¦å‘Šï¼šå¼ºè¡Œä¸­æ­¢è¿æ¥ä¼šå¯¼è‡´æ•°æ®ä¸¢å¤±ï¼ˆä»»åŠ¡å¤±è´¥ï¼‰ã€‚ç¡®è®¤ï¼Ÿ')) {
                        failTask('ä¸»åŠ¨æ”¾å¼ƒ');
                    }
                }
            }
            // æƒ…å†µ 2: è®¡æ—¶å™¨æœªè¿è¡Œï¼ˆå‡†å¤‡å¼€å§‹ï¼‰
            else {
                if (appState.mode === 'work' && !document.getElementById('task-input').value.trim()) {
                    alert('é”™è¯¯ï¼šå¿…é¡»æŒ‡å®šä»»åŠ¡ç›®æ ‡');
                    return;
                }
                startTimer();
            }
        }

        // === ä»»åŠ¡æ¨¡æ¿ (LocalStorage ç‰ˆ - å·²ä¿®å¤æ—¶é—´åŠ è½½é—®é¢˜) ===
        let missionTemplates = [];

        function loadMissionTemplates() {
            const data = localStorage.getItem('cyberMissionTemplates');
            if (data) {
                missionTemplates = JSON.parse(data);
            } else {
                // å¦‚æœæœ¬åœ°æ²¡æœ‰æ•°æ®ï¼ŒåŠ è½½é»˜è®¤æ¨¡æ¿
                missionTemplates = [
                    { name: "DATA HEIST (Standard)", time: 30, seconds: 0 },
                    { name: "SHORT HACK (Quick)", time: 10, seconds: 0 },
                    { name: "CRITICAL BREACH (Deep)", time: 50, seconds: 0 }
                ];
                saveMissionTemplates(); // æŠŠé»˜è®¤çš„å­˜è¿›å»
            }
            renderMissionTemplates();
        }

        function saveMissionTemplates() {
            localStorage.setItem('cyberMissionTemplates', JSON.stringify(missionTemplates));
        }

        function renderMissionTemplates() {
            const container = document.getElementById('mission-template-list');
            container.innerHTML = '';

            if (missionTemplates.length === 0) {
                container.innerHTML = '<div style="color:#666; font-size:10px;">NO TEMPLATES.</div>';
                return;
            }

            missionTemplates.forEach((item, index) => {
                const totalSeconds = (item.time * 60) + (item.seconds || 0);
                // è¾…åŠ©æ ¼å¼åŒ–æ—¶é—´
                const m = Math.floor(totalSeconds / 60).toString().padStart(2, '0');
                const s = (totalSeconds % 60).toString().padStart(2, '0');
                const displayTime = `${m}:${s}`;

                const row = document.createElement('div');
                row.style.cssText = "display:flex; justify-content:space-between; margin-bottom:5px; align-items:center; background:rgba(255,255,255,0.05); padding:5px;";

                // ä»»åŠ¡åç‚¹å‡»ç›´æ¥åº”ç”¨
                const infoSpan = document.createElement('span');
                infoSpan.innerText = `${item.name} (${displayTime})`;
                infoSpan.style.cssText = "cursor:pointer; font-size:12px; color:var(--cp-blue); overflow:hidden; white-space:nowrap; text-overflow:ellipsis; max-width:140px;";
                infoSpan.onclick = () => applyTemplate(item.name, item.time, item.seconds);

                const actionContainer = document.createElement('div');
                actionContainer.style.cssText = "display:flex; gap: 5px;";

                // åˆ é™¤æŒ‰é’®
                const delBtn = document.createElement('span');
                delBtn.innerText = "âœ•";
                delBtn.style.cssText = "cursor:pointer; color:var(--cp-red); padding:0 5px; font-weight:bold; font-size: 14px;";
                delBtn.onclick = (e) => {
                    e.stopPropagation(); // é˜²æ­¢è§¦å‘åº”ç”¨
                    deleteMissionTemplate(index);
                };

                const applyBtn = document.createElement('span');
                applyBtn.innerText = "LOAD";
                applyBtn.style.cssText = "cursor:pointer; color:var(--cp-yellow); font-size: 10px; border: 1px solid var(--cp-yellow); padding: 1px 3px;";
                applyBtn.onclick = () => applyTemplate(item.name, item.time, item.seconds);

                actionContainer.appendChild(applyBtn);
                actionContainer.appendChild(delBtn);
                row.appendChild(infoSpan);
                row.appendChild(actionContainer);
                container.appendChild(row);
            });
        }

        function addMissionTemplate() {
            const nameInput = document.getElementById('new-mission-name');
            const minInput = document.getElementById('new-mission-minutes');
            const secInput = document.getElementById('new-mission-seconds');

            const name = nameInput.value.trim();
            let minutes = parseInt(minInput.value) || 0;
            let seconds = parseInt(secInput.value) || 0;

            if (name === "" || (minutes === 0 && seconds === 0)) {
                alert(">> ERROR: è¾“å…¥æ— æ•ˆ"); return;
            }

            // è¿›ä½é€»è¾‘
            if (seconds >= 60) {
                minutes += Math.floor(seconds / 60);
                seconds = seconds % 60;
            }

            missionTemplates.push({ name, time: minutes, seconds });
            saveMissionTemplates();
            renderMissionTemplates();

            // æ¸…ç©ºè¾“å…¥
            nameInput.value = ''; minInput.value = ''; secInput.value = '';
        }

        function deleteMissionTemplate(index) {
            if (confirm(">> DELETE CONFIRM: ç¡®è®¤åˆ é™¤è¯¥æ¨¡æ¿?")) {
                missionTemplates.splice(index, 1);
                saveMissionTemplates();
                renderMissionTemplates();
            }
        }

        // === æ ¸å¿ƒä¿®å¤ï¼šåº”ç”¨æ¨¡æ¿ ===
        function applyTemplate(name, minutes, seconds = 0) {
            // 1. å®‰å…¨æ£€æŸ¥
            if (appState.active) {
                alert(">> SYSTEM BUSY: æ­£åœ¨æ‰§è¡Œä»»åŠ¡ï¼Œæ— æ³•åŠ è½½æ–°é…ç½®ã€‚");
                return;
            }

            const totalSeconds = (minutes * 60) + (seconds || 0);

            // 2. æ›´æ–°å…¨å±€é…ç½® (è¿™æ ·ä¸‹æ¬¡é‡ç½®æ—¶ä¹Ÿä¼šè®°ä½è¿™ä¸ªæ—¶é—´)
            config.work = totalSeconds / 60; // è¿™é‡Œçš„ config.work å¯èƒ½å˜æˆå°æ•°ï¼Œæ²¡å…³ç³»ï¼Œç¨‹åºæ”¯æŒ

            // 3. æ›´æ–°å½“å‰ç•Œé¢çŠ¶æ€ (å…³é”®ï¼)
            appState.mode = 'work'; // å¼ºåˆ¶åˆ‡å›å·¥ä½œæ¨¡å¼
            appState.timeLeft = totalSeconds;
            appState.totalTime = totalSeconds;

            // 4. æ›´æ–° DOM
            document.getElementById('task-input').value = name;

            // 5. å¼ºåˆ¶åˆ·æ–°å¤§æ—¶é’Ÿæ˜¾ç¤º (è¿™å°±æ˜¯ä¹‹å‰ç¼ºå°‘çš„æ­¥éª¤)
            updateTimerDisplay();
            document.getElementById('progress-bar').style.width = '0%'; // é‡ç½®è¿›åº¦æ¡

            // 6. æ›´æ–°è®¾ç½®é¢æ¿é‡Œçš„è¾“å…¥æ¡† (ä¿æŒåŒæ­¥)
            document.getElementById('cfg-work').value = Math.floor(totalSeconds / 60);

            // 7. è§†è§‰åé¦ˆ
            const badge = document.getElementById('status-badge');
            badge.innerText = "TEMPLATE LOADED";
            badge.style.color = "var(--cp-yellow)";

            // 3ç§’åå˜å› READY
            setTimeout(() => {
                if (!appState.active) {
                    badge.innerText = "READY TO BREACH";
                    badge.style.color = "var(--cp-blue)";
                }
            }, 3000);
        }

        // === è®¡æ—¶å™¨ ===
        function startTimer() {
            appState.active = true;
            appState.paused = false;
            appState.hasPausedInSession = false;
            // å¦‚æœæ˜¯å·¥ä½œæ¨¡å¼ï¼Œè®°å½•ä»»åŠ¡åï¼›å¦‚æœæ˜¯ä¼‘æ¯æ¨¡å¼ï¼Œä»»åŠ¡åè®¾ä¸º SYSTEM COOLING
            appState.currentTask = appState.mode === 'work'
                ? document.getElementById('task-input').value
                : "SYSTEM COOLING";

            appState.totalTime = (appState.mode === 'work' ? config.work : config.break) * 60;

            appState.endTime = Date.now() + appState.totalTime * 1000;
            appState.timeLeft = appState.totalTime;

            document.getElementById('task-input').disabled = true;

            // === ä¿®æ”¹ç‚¹å¼€å§‹ï¼šæ ¹æ®æ¨¡å¼æ”¹å˜æŒ‰é’®å¤–è§‚ ===
            const actionBtn = document.getElementById('action-btn');
            const statusBadge = document.getElementById('status-badge');

            if (appState.mode === 'work') {
                // å·¥ä½œæ¨¡å¼ï¼šçº¢è‰²æŒ‰é’®ï¼Œæ˜¾ç¤ºä¸­æ­¢
                actionBtn.innerText = "ä¸­æ­¢å…¥ä¾µ (ABORT)";
                actionBtn.style.background = "var(--cp-red)";
                actionBtn.style.color = "black";

                statusBadge.innerText = "BREACH IN PROGRESS";
                statusBadge.style.color = "var(--cp-red)";
                document.getElementById('pause-btn').style.display = 'block';
            } else {
                // ä¼‘æ¯æ¨¡å¼ï¼šç»¿è‰²æŒ‰é’®ï¼Œæ˜¾ç¤ºè·³è¿‡
                actionBtn.innerText = ">> è·³è¿‡ä¼‘æ¯ (SKIP) >>";
                actionBtn.style.background = "var(--cp-green)";
                actionBtn.style.color = "black";

                statusBadge.innerText = "SYSTEM REBOOTING";
                statusBadge.style.color = "var(--cp-blue)";
                document.getElementById('pause-btn').style.display = 'none'; // ä¼‘æ¯æ—¶ä¸éœ€è¦æš‚åœåŠŸèƒ½
            }
            // === ä¿®æ”¹ç‚¹ç»“æŸ ===

            updateTimerDisplay();

            // åªæœ‰å·¥ä½œæ¨¡å¼æ‰è‡ªåŠ¨æ’­æ”¾BGMï¼Œä¼‘æ¯æ¨¡å¼ä¸å¼ºåˆ¶æ’­æ”¾ï¼ˆæˆ–è€…ä½ å¯ä»¥æ ¹æ®å–œå¥½ä¿®æ”¹ï¼‰
            const bgm = document.getElementById('bgm-player');
            if (bgm.src && appState.mode === 'work') bgm.play().catch(() => { });

            timerWorker.postMessage('start');
        }

        function tick() {
            const now = Date.now();
            const remaining = Math.round((appState.endTime - now) / 1000);

            appState.timeLeft = remaining;

            if (appState.timeLeft <= 0) {
                appState.timeLeft = 0;
                updateTimerDisplay();
                updateProgressBar();
                completeSession();
            } else {
                updateTimerDisplay();
                updateProgressBar();
            }
        }

        // ==========================================
        // 3. PAUSE PROTOCOL
        // ==========================================
        function requestPause() {
            document.getElementById('pause-modal').style.display = 'flex';
            document.getElementById('pause-reason-input').value = '';
            document.getElementById('confirm-pause-btn').disabled = false;
        }

        function cancelPauseRequest() {
            document.getElementById('pause-modal').style.display = 'none';
        }

        function confirmPause() {
            const btn = document.getElementById('confirm-pause-btn');
            btn.disabled = true;

            const reason = document.getElementById('pause-reason-input').value.trim();
            if (reason.length < 10) {
                alert('ç†ç”±ä¸å¤Ÿå……åˆ† (è‡³å°‘10å­—)');
                btn.disabled = false;
                return;
            }

            document.getElementById('pause-modal').style.display = 'none';
            appState.paused = true;
            appState.hasPausedInSession = true;

            appState.pauseEndTime = Date.now() + 600 * 1000;

            document.getElementById('status-badge').innerText = "CONNECTION SUSPENDED";
            document.getElementById('pause-btn').innerText = "æ¢å¤è¿æ¥";
            document.getElementById('pause-btn').onclick = resumeTimer;

            document.getElementById('bgm-player').pause();
            // Pause tick managed by worker
        }

        function pauseTick() {
            const pNow = Date.now();
            const pRem = Math.round((appState.pauseEndTime - pNow) / 1000);

            // æš‚åœæ—¶ä¹ŸæŠŠæ—¶é—´æ”¾å‰é¢
            document.title = `${formatTime(pRem)} | âš ï¸ PAUSED`;

            if (pRem <= 0) {
                failTask('æš‚åœè¶…æ—¶ (ç¥ç»è¿æ¥æ–­å¼€)');
            }
        }

        function resumeTimer() {
            appState.paused = false;
            appState.endTime = Date.now() + appState.timeLeft * 1000;

            document.getElementById('status-badge').innerText = "BREACH IN PROGRESS";
            document.getElementById('pause-btn').innerText = "// ç”³è¯·æŒ‚èµ·";
            document.getElementById('pause-btn').onclick = requestPause;

            const bgm = document.getElementById('bgm-player');
            if (bgm.src) bgm.play().catch(() => { });

            updateTimerDisplay();
        }

        // ==========================================
        // 4. COMPLETION & FAIL
        // ==========================================
        function completeSession() {
            timerWorker.postMessage('stop');
            playBeep();

            if (appState.mode === 'work') {
                document.getElementById('rating-modal').style.display = 'flex';
                document.getElementById('submit-rating-btn').disabled = false;
                setRating(3);
            } else {
                alert("ç³»ç»Ÿå†·å´å®Œæ¯•ã€‚");
                appState.mode = 'work';
                resetUI();
            }
        }

        function failTask(reason) {
            timerWorker.postMessage('stop');
            saveRecord(appState.currentTask, (appState.totalTime - appState.timeLeft) / 60, 0, false, reason);
            alert(`ä»»åŠ¡å¤±è´¥: ${reason}`);
            resetUI();
        }

        function submitRating() {
            const btn = document.getElementById('submit-rating-btn');
            btn.disabled = true;

            document.getElementById('rating-modal').style.display = 'none';
            saveRecord(appState.currentTask, config.work, appState.tempRating, true);

            checkHealth();

            if (confirm('æ•°æ®ä¸Šä¼ å®Œæ¯•ã€‚è¿›å…¥å†·å´æ¨¡å¼ï¼Ÿ')) {
                appState.mode = 'break';
                startTimer();
            } else {
                resetUI();
            }
        }

        function resetUI() {
            appState.active = false;
            appState.paused = false;
            appState.hasPausedInSession = false;
            timerWorker.postMessage('stop');

            document.getElementById('task-input').disabled = false;
            document.getElementById('action-btn').innerText = "å¼€å§‹å…¥ä¾µ";
            document.getElementById('action-btn').style.background = "var(--cp-yellow)";
            document.getElementById('pause-btn').style.display = 'none';
            document.getElementById('status-badge').innerText = "READY TO BREACH";
            document.getElementById('status-badge').style.color = "var(--cp-blue)";

            document.getElementById('progress-bar').style.width = '0%';

            // é‡ç½®æ—¶é—´æ˜¾ç¤ºå¹¶æ›´æ–°æ ‡é¢˜
            appState.timeLeft = (appState.mode === 'work' ? config.work : config.break) * 60;
            updateTimerDisplay();

            document.getElementById('bgm-player').pause();
        }

        // ==========================================
        // 5. DATA, ACHIEVEMENTS & PURGE
        // ==========================================
        function purgeData() {
            if (confirm("âš ï¸ ä¸¥é‡è­¦å‘Š âš ï¸\n\næ‚¨æ­£åœ¨æ‰§è¡Œæ•°æ®åº“æ¸…æ´—æ“ä½œã€‚\nè¿™å°†æ°¸ä¹…åˆ é™¤æ‰€æœ‰å†å²è®°å½•ã€æˆå°±å’Œç»Ÿè®¡æ•°æ®ã€‚\n\næ˜¯å¦ç»§ç»­ï¼Ÿ")) {
                localStorage.removeItem('cp_logs');
                localStorage.removeItem('cp_achievements');
                localStorage.removeItem('cyberMissionTemplates');
                // å…³é”®ï¼šåŒæ—¶åˆ·æ–°ä¸¤ä¸ªè§†å›¾
                renderStats();
                renderAchievements();

                alert(">> ç³»ç»Ÿæ ¼å¼åŒ–å®Œæˆã€‚\n>> æ‰€æœ‰æ•°æ®å·²æ¸…é™¤ã€‚");
            }
        }

        function saveRecord(task, duration, rating, success, failReason = '') {
            const records = JSON.parse(localStorage.getItem('cp_logs') || '[]');
            const now = new Date();
            const record = {
                date: now.toISOString(),
                dayStr: now.toISOString().split('T')[0],
                task, duration: Math.floor(duration), rating, success, failReason,
                interrupted: appState.hasPausedInSession
            };
            records.push(record);
            localStorage.setItem('cp_logs', JSON.stringify(records));

            checkAchievements(records);
        }

        function checkAchievements(records) {
            let unlocked = JSON.parse(localStorage.getItem('cp_achievements') || '[]');
            const totalMinutes = records.filter(r => r.success).reduce((acc, cur) => acc + cur.duration, 0);

            if (totalMinutes >= 60 && !unlocked.includes('rookie')) unlocked.push('rookie');
            if (totalMinutes >= 900 && !unlocked.includes('thinker')) unlocked.push('thinker');
            if (records.some(r => r.success && r.interrupted) && !unlocked.includes('resilient')) unlocked.push('resilient');

            const last10 = records.filter(r => r.success).slice(-10);
            if (last10.length >= 10) {
                const avg = last10.reduce((a, b) => a + b.rating, 0) / 10;
                if (avg >= 4 && !unlocked.includes('highroller')) unlocked.push('highroller');
            }

            const uniqueDays = [...new Set(records.filter(r => r.success).map(r => r.dayStr))].sort();
            let streak = 0;
            for (let i = 0; i < uniqueDays.length - 1; i++) {
                const d1 = new Date(uniqueDays[i]);
                const d2 = new Date(uniqueDays[i + 1]);
                const diffTime = Math.abs(d2 - d1);
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                if (diffDays === 1) streak++; else streak = 0;
                if (streak >= 6 && !unlocked.includes('durable')) { unlocked.push('durable'); break; }
            }

            localStorage.setItem('cp_achievements', JSON.stringify(unlocked));
            renderAchievements();
        }

        function renderAchievements() {
            const list = JSON.parse(localStorage.getItem('cp_achievements') || '[]');
            const container = document.getElementById('ach-container');
            const descBox = document.getElementById('ach-desc');
            container.innerHTML = '';

            Object.keys(ACH_DEFS).forEach(key => {
                const div = document.createElement('div');
                div.className = 'ach-badge ' + (list.includes(key) ? 'unlocked' : '');
                div.innerText = ACH_DEFS[key].icon;

                div.onmouseenter = () => {
                    descBox.innerText = ACH_DEFS[key].title;
                    descBox.style.color = list.includes(key) ? 'var(--cp-green)' : 'var(--cp-blue)';
                };
                div.onmouseleave = () => {
                    descBox.innerText = "HOVER ICON FOR DETAILS";
                    descBox.style.color = "var(--cp-blue)";
                };

                container.appendChild(div);
            });
        }

        function checkHealth() {
            const records = JSON.parse(localStorage.getItem('cp_logs') || '[]');
            const todayStr = new Date().toISOString().split('T')[0];
            const todayMins = records.filter(r => r.dayStr === todayStr && r.success).reduce((a, b) => a + b.duration, 0);

            if (todayMins >= 180 && todayMins < 180 + config.work) {
                alert("âš ï¸ è­¦å‘Šï¼šçªè§¦å‹åŠ›è¿‡å¤§ \nä»Šæ—¥å·²æ¥å…¥è¶…3å°æ—¶ã€‚å»ºè®®æ–­å¼€è¿æ¥ï¼Œå‰å¾€å¤œä¹‹åŸè¿›è¡Œè‚‰ä½“æ´»åŠ¨ã€‚");
            }
        }

        // ==========================================
        // 6. UTILS & VISUALS
        // ==========================================
        function updateTimerDisplay() {
            const m = Math.floor(appState.timeLeft / 60).toString().padStart(2, '0');
            const s = (appState.timeLeft % 60).toString().padStart(2, '0');
            const str = `${m}:${s}`;
            document.getElementById('timer').innerText = str;

            // å…³é”®ä¿®å¤ï¼šæ—¶é—´å§‹ç»ˆåœ¨å‰ï¼Œç¡®ä¿å³ä½¿æ ‡ç­¾é¡µå¾ˆå°ä¹Ÿèƒ½çœ‹åˆ°æ—¶é—´
            if (appState.active && !appState.paused) {
                document.title = `${str} | ACTIVE`;
            } else if (!appState.active) {
                document.title = `${str} | READY`;
            }
        }

        function updateProgressBar() {
            const percent = ((appState.totalTime - appState.timeLeft) / appState.totalTime) * 100;
            document.getElementById('progress-bar').style.width = percent + '%';
        }

        function formatTime(sec) {
            const m = Math.floor(sec / 60);
            const s = sec % 60;
            return `${m}:${s.toString().padStart(2, '0')}`;
        }

        function playBeep() {
            const ctx = new (window.AudioContext || window.webkitAudioContext)();
            const osc = ctx.createOscillator();
            const gain = ctx.createGain();
            osc.connect(gain);
            gain.connect(ctx.destination);
            osc.type = 'sawtooth';
            osc.frequency.setValueAtTime(440, ctx.currentTime);
            osc.frequency.exponentialRampToValueAtTime(880, ctx.currentTime + 0.1);
            gain.gain.setValueAtTime(0.1, ctx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.5);
            osc.start();
            osc.stop(ctx.currentTime + 0.5);
        }

        // === é€šç”¨ä¸Šä¼ å¤„ç† ===
        // å¢åŠ ç¬¬ä¸‰ä¸ªå‚æ•° autoApplyï¼Œé»˜è®¤ä¸º false
        async function handleFileUpload(input, type, autoApply = false) {
            if (input.files && input.files[0]) {
                const file = input.files[0];
                try {
                    // 1. ä¿å­˜åˆ°æ•°æ®åº“
                    await CyberDB.addMedia(type, file);

                    // 2. æ ¹æ®ç±»å‹åˆ†åˆ«å¤„ç†
                    if (type === 'audio') {
                        renderLocalAudio();
                        alert(">> AUDIO DATABANK UPDATED");
                    }
                    else {
                        // === å£çº¸å¤„ç†é€»è¾‘ ===

                        // A. æ— è®ºå¦‚ä½•å…ˆåˆ·æ–°åˆ—è¡¨ï¼Œç¡®ä¿æ–°å›¾å‡ºç°åœ¨åº“é‡Œ
                        await renderLocalBg();

                        // B. åªæœ‰ autoApply ä¸º true æ—¶ï¼Œæ‰æ‰§è¡Œæ¢å£çº¸çš„æ“ä½œ
                        if (autoApply) {
                            const url = URL.createObjectURL(file);
                            document.getElementById('bg-layer').style.backgroundImage = `url('${url}')`;

                            // é«˜äº®æœ€åä¸€å¼ å›¾
                            document.querySelectorAll('.bg-thumb').forEach(b => b.classList.remove('active-bg'));
                            const allThumbs = document.querySelectorAll('#local-bg-list .bg-thumb');
                            if (allThumbs.length > 0) {
                                allThumbs[allThumbs.length - 1].classList.add('active-bg');
                            }
                        } else {
                            // å¦‚æœä¸è‡ªåŠ¨åº”ç”¨ï¼Œä¸ºäº†æç¤ºç”¨æˆ·æˆåŠŸï¼Œå¯ä»¥ç¨å¾®é—ªçƒä¸€ä¸‹åˆ—è¡¨æˆ–è€…ç»™ä¸ªè½»å¾®æç¤ºï¼ˆå¯é€‰ï¼‰
                            // è¿™é‡Œæˆ‘ä»¬é€‰æ‹©é™é»˜æ›´æ–°ï¼Œæˆ–è€…ä½ å¯ä»¥åŠ ä¸ª console.log
                            console.log(">> Image added to gallery silently.");
                        }
                    }

                } catch (e) {
                    console.error(e);
                    alert(">> SYSTEM ERROR: æ•°æ®å†™å…¥å¤±è´¥");
                }
                // æ¸…ç©º input
                input.value = '';
            }
        }

        // === æ¸²æŸ“éŸ³é¢‘åˆ—è¡¨ (å·²ä¿®å¤éŸ³é‡å’Œåœæ­¢é€»è¾‘) ===
        async function renderLocalAudio() {
            const list = await CyberDB.getAllByType('audio');
            const container = document.getElementById('local-audio-list');
            container.innerHTML = '';

            if (list.length === 0) {
                container.innerHTML = '<div style="color:#666; font-size:10px;">NO DATA IN DRIVE</div>';
                return;
            }

            list.forEach(item => {
                const row = document.createElement('div');
                row.style.cssText = "display:flex; justify-content:space-between; margin-bottom:5px; align-items:center; background:rgba(255,255,255,0.05); padding:5px;";

                const playBtn = document.createElement('span');
                playBtn.innerText = `â–¶ ${item.name}`;
                playBtn.style.cssText = "cursor:pointer; font-size:12px; color:#ccc; overflow:hidden; white-space:nowrap; text-overflow:ellipsis; max-width:180px;";

                playBtn.onclick = () => {
                    const url = URL.createObjectURL(item.blob);
                    const bgm = document.getElementById('bgm-player');

                    // 1. å…ˆæŠŠç”µå°åœäº†ä½†ä¸è°ƒç”¨ stopRadio() ï¼ˆå› ä¸ºé‚£ä¼šæŠŠ UI å…¨é‡ç½®äº†)
                    radioPlayer.pause();
                    document.querySelectorAll('.station-btn').forEach(b => b.classList.remove('active-station'));

                    // 2. è®¾ç½®æºå¹¶æ’­æ”¾
                    bgm.src = url;

                    // 3. ç«‹å³åŒæ­¥å½“å‰çš„éŸ³é‡æ»‘å—å€¼
                    const volInput = document.querySelector('.cyber-range');
                    if (volInput) {
                        bgm.volume = volInput.value / 100;
                    }

                    bgm.play();

                    // 4. æ›´æ–°é¢æ¿çŠ¶æ€ (è®© CUT SIGNAL æŒ‰é’®äº®èµ·æ¥ï¼Œæ˜¾ç¤ºå½“å‰æ­Œå)
                    updateRadioStatus(`LOCAL: ${item.name}`, true);
                    const cutBtn = document.getElementById("cut-signal-btn");
                    if (cutBtn) {
                        cutBtn.style.background = "var(--cp-yellow)";
                        cutBtn.style.color = "black";
                        cutBtn.style.boxShadow = "0 0 10px var(--cp-yellow)";
                    }
                };

                const delBtn = document.createElement('span');
                delBtn.innerText = "âœ•";
                delBtn.style.cssText = "cursor:pointer; color:var(--cp-red); padding:0 5px; font-weight:bold;";
                delBtn.onclick = async (e) => {
                    e.stopPropagation();
                    if (confirm("DELETE FILE?")) {
                        await CyberDB.deleteMedia(item.id);
                        renderLocalAudio();
                    }
                };

                row.appendChild(playBtn);
                row.appendChild(delBtn);
                container.appendChild(row);
            });
        }
        // === æ¸²æŸ“èƒŒæ™¯åˆ—è¡¨ ===
        async function renderLocalBg() {
            const list = await CyberDB.getAllByType('image');
            const container = document.getElementById('local-bg-list');
            container.innerHTML = '';

            list.forEach(item => {
                const url = URL.createObjectURL(item.blob); // ç”Ÿæˆé¢„è§ˆå›¾

                const wrapper = document.createElement('div');
                wrapper.style.position = 'relative';

                const btn = document.createElement('button');
                btn.className = 'bg-thumb';
                btn.style.backgroundImage = `url('${url}')`;
                btn.style.width = '100%';
                btn.onclick = () => {
                    document.getElementById('bg-layer').style.backgroundImage = `url('${url}')`;
                    // é«˜äº®é€»è¾‘
                    document.querySelectorAll('.bg-thumb').forEach(b => b.classList.remove('active-bg'));
                    btn.classList.add('active-bg');
                };

                // åˆ é™¤æŒ‰é’®æ‚¬æµ®åœ¨å³ä¸Šè§’
                const delBtn = document.createElement('div');
                delBtn.innerText = "âœ•";
                delBtn.style.cssText = "position:absolute; top:0; right:0; background:var(--cp-red); color:black; font-size:10px; width:20px; height:20px; display:flex; justify-content:center; align-items:center; cursor:pointer;";
                delBtn.onclick = async (e) => {
                    e.stopPropagation();
                    if (confirm("DELETE IMG?")) {
                        await CyberDB.deleteMedia(item.id);
                        renderLocalBg();
                    }
                };

                wrapper.appendChild(btn);
                wrapper.appendChild(delBtn);
                container.appendChild(wrapper);
            });
        }

        // === ç»‘å®šåˆ° Input äº‹ä»¶ ===
        // é‡æ–°å®šä¹‰è¿™ä¸¤ä¸ªå‡½æ•°ï¼Œè®© input onchange è°ƒç”¨æˆ‘ä»¬çš„æ–°é€»è¾‘
        window.loadMusic = function (input) { handleFileUpload(input, 'audio'); };
        window.loadBackground = function (input) { handleFileUpload(input, 'image'); };
        function switchBackground(element) {
            // 1. è·å–ç‚¹å‡»æŒ‰é’®ä¸Šè®°å½•çš„å›¾ç‰‡è·¯å¾„ (data-src å±æ€§)
            const newBgSrc = element.getAttribute('data-src');

            // 2. è®¾ç½®ç»™èƒŒæ™¯å±‚
            // ä½¿ç”¨çº¿æ€§æ¸å˜å åŠ ï¼Œç¡®ä¿å›¾ç‰‡ä¸ä¼šå¤ªäº®ï¼Œä¿æŒæ–‡å­—å¯è¯»æ€§ï¼ˆå»¶ç»­äº†ä½ åŸæœ‰çš„é£æ ¼ï¼‰
            // å¦‚æœä½ æƒ³è¦åŸå›¾æ›´äº®ä¸€ç‚¹ï¼Œå¯ä»¥è°ƒæ•´è¿™é‡Œçš„ rgba å€¼
            document.getElementById('bg-layer').style.backgroundImage = `url('${newBgSrc}')`;

            // 3. æ›´æ–°è§†è§‰çŠ¶æ€ï¼ˆé«˜äº®é€‰ä¸­çš„ç¼©ç•¥å›¾ï¼‰
            // å…ˆç§»é™¤æ‰€æœ‰ç¼©ç•¥å›¾çš„é«˜äº®
            document.querySelectorAll('.bg-thumb').forEach(btn => {
                btn.classList.remove('active-bg');
            });
            // å†ç»™è‡ªå·±åŠ ä¸Šé«˜äº®
            element.classList.add('active-bg');
        }


        function setRating(v) {
            appState.tempRating = v;
            document.querySelectorAll('.star-btn').forEach(b => {
                b.classList.toggle('active', parseInt(b.dataset.v) <= v);
            });
        }

        function renderStats() {
            const records = JSON.parse(localStorage.getItem('cp_logs') || '[]');
            const todayStr = new Date().toISOString().split('T')[0];

            const todayMins = records.filter(r => r.dayStr === todayStr && r.success).reduce((a, b) => a + b.duration, 0);
            document.getElementById('today-total').innerText = todayMins + " MIN";

            const listEl = document.getElementById('task-list');
            listEl.innerHTML = '';
            records.slice().reverse().slice(0, 20).forEach(r => {
                const color = r.success ? 'var(--cp-blue)' : 'var(--cp-red)';
                const ratingStr = r.success ? "â˜…".repeat(r.rating) : "å¤±è´¥";
                const txt = `<span>${r.task}</span> <span style="color:${color}">${ratingStr}</span>`;

                const div = document.createElement('div');
                div.style.borderBottom = "1px solid #222"; div.style.padding = "6px 0";
                div.style.display = "flex"; div.style.justifyContent = "space-between";
                div.style.color = "#ccc";
                div.innerHTML = txt;
                listEl.appendChild(div);
            });

            setTimeout(() => drawChart(records), 50);
        }

        function drawChart(records) {
            const canvas = document.getElementById('trendChart');
            if (!canvas) return;
            const ctx = canvas.getContext('2d');
            const w = canvas.width = canvas.offsetWidth;
            const h = canvas.height = canvas.offsetHeight;

            ctx.clearRect(0, 0, w, h);

            ctx.strokeStyle = "rgba(0, 240, 255, 0.1)";
            ctx.lineWidth = 1;
            ctx.beginPath();
            for (let i = 1; i < 5; i++) {
                let y = i * (h / 5);
                ctx.moveTo(0, y); ctx.lineTo(w, y);
            }
            ctx.stroke();

            const data = records.filter(r => r.success).slice(-10).map(r => r.rating);
            if (data.length === 0) return;

            ctx.strokeStyle = "#fcee0a";
            ctx.lineWidth = 2;
            ctx.beginPath();

            if (data.length === 1) {
                const y = h - (data[0] / 5.5 * h) - 5;
                ctx.moveTo(0, y); ctx.lineTo(w, y);
            } else {
                const step = w / (data.length - 1);
                data.forEach((v, i) => {
                    const x = i * step;
                    const y = h - (v / 5.5 * h) - 5;
                    if (i === 0) ctx.moveTo(x, y); else ctx.lineTo(x, y);
                });
            }
            ctx.stroke();

            ctx.lineTo(w, h);
            ctx.lineTo(0, h);
            ctx.fillStyle = "rgba(252, 238, 10, 0.1)";
            ctx.fill();
        }

        function togglePanel(id) {
            const target = document.getElementById(id + '-panel');
            const isActive = target.classList.contains('active');
            const btn = document.getElementById('btn-' + id);

            closeAllPanels();

            if (!isActive) {
                target.classList.add('active');
                if (btn) btn.classList.add('active-btn');
                if (id === 'stats') renderStats();
            }
        }

        function closeAllPanels() {
            document.querySelectorAll('.slide-panel').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active-btn'));
        }

        function saveSettings() {
            config.work = parseInt(document.getElementById('cfg-work').value) || 30;
            config.break = parseInt(document.getElementById('cfg-break').value) || 5;
            localStorage.setItem('cp_config', JSON.stringify(config));
            closeAllPanels();
            if (!appState.active) resetUI();
        }

        // ==========================================
        // X. RADIO SYSTEM 
        const STATIONS = [
            { name: "ACID RAIN", src: "./music/rain.m4a" },      // é›¨å£°
            { name: "MIDNIGHT JAZZ", src: "./music/jazz.m4a" },   // çˆµå£«
            { name: "NEON SYNTH", src: "./music/synth.m4a" },     // Synthwave
            { name: "STREET HIPHOP", src: "./music/hiphop.m4a" },  // Hiphop
            { name: "STATIC NOISE", src: "./music/white.m4a" }     // ç™½å™ªéŸ³
        ];

        let radioPlayer = new Audio();
        radioPlayer.loop = true; // ç”µå°å¾ªç¯æ’­æ”¾
        let currentStationIndex = -1;

        function switchStation(index) {
            // 1. æ›´æ–°è§†è§‰çŠ¶æ€
            const btns = document.querySelectorAll('.station-btn');
            btns.forEach((btn, i) => {
                if (i === index) btn.classList.add('active-station');
                else btn.classList.remove('active-station');
            });

            // 2. å¦‚æœç‚¹å‡»çš„æ˜¯åŒä¸€ä¸ªï¼Œä¸åšåŠ¨ä½œï¼ˆæˆ–è€…ä½ å¯ä»¥é€‰æ‹©æš‚åœï¼Œè¿™é‡Œè®¾ä¸ºä¸åšåŠ¨ä½œï¼‰
            if (currentStationIndex === index && !radioPlayer.paused) return;

            // 3. åˆ‡æ¢éŸ³é¢‘
            currentStationIndex = index;
            const station = STATIONS[index];

            // å¦‚æœç”¨æˆ·ä¸Šä¼ äº†BGMï¼Œä¸ºäº†é˜²æ­¢åµæ‚ï¼Œå¯ä»¥é€‰æ‹©æš‚åœåŸæœ‰çš„BGMï¼ˆå¯é€‰ï¼‰
            // document.getElementById('bgm-player').pause(); 

            radioPlayer.src = station.src;
            radioPlayer.play().then(() => {
                updateRadioStatus(`RECEIVING: ${station.name}`, true);
                const cutBtn = document.getElementById("cut-signal-btn");
                if (cutBtn) {
                    cutBtn.style.background = "var(--cp-yellow)";
                    cutBtn.style.color = "black";
                    cutBtn.style.boxShadow = "0 0 10px var(--cp-yellow)";
                }
            }).catch(e => {
                console.error("æ— æ³•æ’­æ”¾ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶è·¯å¾„", e);
                updateRadioStatus("SIGNAL LOST (NO FILE)", false);
            });
        }

        function stopRadio() {
            // 1. åœæ­¢ç”µå°
            radioPlayer.pause();
            radioPlayer.currentTime = 0;
            currentStationIndex = -1;

            // 2. åœæ­¢æœ¬åœ°éŸ³ä¹ 
            const bgm = document.getElementById('bgm-player');
            bgm.pause();
            // bgm.currentTime = 0; // å¦‚æœä½ æƒ³ä¿ç•™æ’­æ”¾è¿›åº¦ï¼Œè¿™è¡Œå¯ä»¥æ³¨é‡Šæ‰

            // 3. UI çŠ¶æ€å¤ä½
            document.querySelectorAll('.station-btn').forEach(b => b.classList.remove('active-station'));
            updateRadioStatus("OFFLINE", false);

            // 4. è®©æŒ‰é’®å˜å›ç°è‰²
            const cutBtn = document.getElementById("cut-signal-btn");
            if (cutBtn) {
                cutBtn.style.background = "#333";
                cutBtn.style.color = "#888";
                cutBtn.style.boxShadow = "none";
            }
        }

        function setRadioVolume(val) {
            const v = val / 100;
            // 1. æ§åˆ¶ç”µå°éŸ³é‡
            radioPlayer.volume = v;
            // 2. æ§åˆ¶æœ¬åœ°éŸ³ä¹éŸ³é‡ 
            const bgm = document.getElementById('bgm-player');
            if (bgm) bgm.volume = v;
        }

        function updateRadioStatus(text, isActive) {
            const el = document.getElementById('radio-status');
            el.innerText = text;
            el.style.color = isActive ? "var(--cp-yellow)" : "var(--cp-green)";
            el.style.textShadow = isActive ? "0 0 5px var(--cp-yellow)" : "none";
        }

        // ==========================================
        // Z. FULLSCREEN TOGGLE (å›¾æ ‡ç‰ˆ)
        // ==========================================
        function toggleFullScreen() {
            const btn = document.getElementById('btn-full');

            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen().catch(err => {
                    console.log(err);
                });
                btn.innerHTML = "âœ•"; // é€€å‡ºå›¾æ ‡ (å‰å·)
            } else {
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                }
                btn.innerHTML = "â›¶"; // è¿›å…¥å›¾æ ‡
            }
        }

        document.addEventListener('fullscreenchange', () => {
            const btn = document.getElementById('btn-full');
            // å¦‚æœç”±äºæŒ‰ ESC é€€å‡ºï¼Œå›¾æ ‡ä¹Ÿè¦å˜å›æ¥
            if (!document.fullscreenElement) {
                btn.innerHTML = "â›¶";
            } else {
                btn.innerHTML = "âœ•";
            }
        });

        // ==========================================
        // THREE.JS PARTICLES
        // ==========================================
        function initThree() {
            const container = document.getElementById('canvas-container');
            const scene = new THREE.Scene();
            const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 1, 2000);
            camera.position.z = 1000;
            const renderer = new THREE.WebGLRenderer({ alpha: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            container.appendChild(renderer.domElement);

            const geo = new THREE.BufferGeometry();
            const pos = []; const col = [];
            const pal = [new THREE.Color('#fcee0a'), new THREE.Color('#00f0ff'), new THREE.Color('#ff003c')];

            for (let i = 0; i < 1000; i++) {
                pos.push(Math.random() * 2000 - 1000, Math.random() * 2000 - 1000, Math.random() * 2000 - 1000);
                const c = pal[Math.floor(Math.random() * 3)];
                col.push(c.r, c.g, c.b);
            }
            geo.setAttribute('position', new THREE.Float32BufferAttribute(pos, 3));
            geo.setAttribute('color', new THREE.Float32BufferAttribute(col, 3));
            const mat = new THREE.PointsMaterial({ size: 3, vertexColors: true, transparent: true, opacity: 0.6 });
            const parts = new THREE.Points(geo, mat);
            scene.add(parts);

            function anim() {
                requestAnimationFrame(anim);
                parts.rotation.y += 0.0005;
                renderer.render(scene, camera);
            }
            anim();
            window.addEventListener('resize', () => {
                camera.aspect = window.innerWidth / window.innerHeight; camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
            });
        }
    </script>
    <button id="btn-full" class="fullscreen-corner-btn" onclick="toggleFullScreen()">â›¶</button>
</body>

</html>